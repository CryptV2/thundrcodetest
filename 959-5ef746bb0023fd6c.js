"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[959],{7959:function(e,t,r){r.r(t),r.d(t,{default:function(){return m}});var n=r(5893),c=r(7747),a=r(5395),o=r(7294),s=r(8186),i=(e,t,r,n,c,a,s)=>{let i=(0,o.useRef)(null),u=(0,o.useRef)(null),l=(0,o.useRef)([]),d=(0,o.useRef)(null),f=(0,o.useRef)(null),g=(0,o.useRef)(null),m=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}],h=e=>{var t;null===(t=s.current)||void 0===t||t.updateProgress({connection_attempt:0,local_stream_initialized:0,ice_servers_fetched:4,peerconnection_initialized:8,local_tracks_added:12,offer_created:12.5,local_description_set:25,offer_sent:37.5,waiting_for_answer:50,answer_received:62.5,remote_description_set:75,offer_received:12.5,remote_description_set:25,answer_created:37.5,local_description_set:50,answer_sent:62.5,ice_gathering_complete:87.5,connection_established:100,disconnected:0}[e]||0)},v=e=>{var t;null===(t=s.current)||void 0===t||t.updateVisible(e)},w=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{video:!0,audio:!0};try{h("connection_attempt"),r.current&&r.current.getTracks().forEach(e=>e.stop()),r.current=await navigator.mediaDevices.getUserMedia(e),c.current(r.current),h("local_stream_initialized")}catch(e){console.error("%%% error initializing local stream: ".concat(e," %%%"))}},p=async()=>{try{let e=await fetch("/api/cloudflarewebrtc",{method:"POST"}),t=await e.json();if(Array.isArray(t.iceServers))d.current=t.iceServers;else if(t.iceServers&&"object"==typeof t.iceServers)d.current=[t.iceServers];else throw Error("Invalid ICE servers format")}catch(e){d.current=m}h("ice_servers_fetched")},_=async e=>{v(!0),d.current||await p(),u.current=new RTCPeerConnection({iceServers:d.current}),h("peerconnection_initialized"),y(e),r.current&&(r.current.getTracks().forEach(e=>{u.current.addTrack(e,r.current)}),h("local_tracks_added"))},R=async()=>{u.current&&($(),"closed"!==u.current.signalingState&&(u.current.getSenders().forEach(e=>{u.current.removeTrack(e)}),await u.current.close()),u.current=null),l.current=[],f.current=null},y=e=>{u.current.onicecandidate=r=>{let{candidate:n}=r;n&&a.current.push("webrtc_message",{type:"ice-candidate",data:n,from:t,to:e})},u.current.ontrack=e=>{n.current(e.streams[0])},u.current.onicegatheringstatechange=()=>{"complete"===u.current.iceGatheringState&&h("ice_gathering_complete")},u.current.oniceconnectionstatechange=async()=>{let e=u.current.iceConnectionState;("disconnected"===e||"failed"===e)&&(j(),h("disconnected"))},u.current.onconnectionstatechange=async()=>{let e=u.current.connectionState;"connected"===e?(g.current&&clearTimeout(g.current),h("connection_established")):"failed"===e&&(j(),h("disconnected"))}},$=()=>{u.current&&(u.current.onicecandidate=null,u.current.ontrack=null,u.current.onnegotiationneeded=null,u.current.onicegatheringstatechange=null,u.current.oniceconnectionstatechange=null,u.current.onconnectionstatechange=null)},x=async(e,t)=>{if(e.from===t)switch(e.type){case"offer":await S(e.data,e.from);break;case"answer":await k(e.data,e.from);break;case"ice-candidate":await b(e.data,e.from)}},S=async(e,r)=>{h("offer_received"),await _(r),await u.current.setRemoteDescription(new RTCSessionDescription(e)),h("remote_description_set");let n=await u.current.createAnswer();h("answer_created"),await u.current.setLocalDescription(n),h("local_description_set"),await a.current.push("webrtc_message",{type:"answer",data:n,from:t,to:r}),h("answer_sent"),await C()},k=async(e,t)=>{var r;(null===(r=u.current)||void 0===r?void 0:r.signalingState)==="have-local-offer"&&(h("answer_received"),await u.current.setRemoteDescription(new RTCSessionDescription(e)),h("remote_description_set"),await C())},b=async e=>{var t;if(!(null===(t=u.current)||void 0===t?void 0:t.remoteDescription)){l.current.push(e);return}await u.current.addIceCandidate(e)},C=async()=>{for(;l.current.length>0;){let e=l.current.shift();await u.current.addIceCandidate(e)}},T=async e=>{await _(e);let t=await u.current.createOffer({iceRestart:!0});return h("offer_created"),await u.current.setLocalDescription(t),h("local_description_set"),t},D=async(e,r)=>{a.current.push("webrtc_message",{type:"offer",data:r,from:t,to:e}),h("offer_sent")},E=async()=>{h("disconnected"),v(!1),await R(),$(),l.current=[]},j=()=>{M()},M=async function(){let{reinitializeLocalStream:t=!1,constraints:r={}}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{t&&await w(r);let n=await T(e.current.id);await D(e.current.id,n)}catch(e){console.warn("%%% error during reconnection: ".concat(e," %%%"))}},A=()=>{u.current&&($(),u.current.close(),u.current=null),r.current&&(r.current.getTracks().forEach(e=>e.stop()),r.current=null),l.current=[],d.current=null,f.current=null,clearTimeout(i.current),i.current=null};return(0,o.useEffect)(()=>(w(),()=>{A()}),[]),{createOffer:T,sendOffer:D,endVideo:E,isStreaming:()=>r.current,handleWebRTCMessage:x,reconnect:M}},u=r(550),l=r(1318),d=r(6069),f=r(1908),g=r(2684),m=e=>{let{initialMode:t}=e,{getSettings:r}=(0,l.r)(),{getUser:m}=(0,u.a)();var h,v,w,p,_,R,y=r(),$=m();let x=null==$?void 0:$.id,{currentBoost:S}=(0,d.j)(),{playSound:k}=(0,s.Q)(["assets/sounds/online.mp3","assets/sounds/type.mp3","assets/sounds/message.mp3","assets/sounds/disconnect.mp3"]),b=(0,o.useRef)(),C=(0,o.useRef)(),T=(0,o.useRef)(),D=(0,o.useRef)({}),E=(0,o.useRef)(),j=(0,o.useRef)(!1),M=(0,o.useRef)(!1),A=(0,o.useRef)(null),L=(0,o.useRef)(),I=(0,o.useRef)(),z=(0,o.useRef)(),O=(0,o.useRef)(()=>{}),P=(0,o.useRef)(),U=(0,o.useRef)(),V=(0,o.useRef)(),F=(0,o.useRef)({set:()=>{}}),B=(0,o.useRef)({value:""}),N=(0,o.useRef)(),G=(0,o.useRef)(),Q=(0,o.useRef)(),[W,Y]=(0,o.useState)(t),q=(0,o.useRef)(null),H=(0,o.useRef)(null),J=(0,o.useRef)({toggleSpinner:()=>{},updateStatus:()=>{}});(0,o.useEffect)(()=>(b.current||ec(),K(),window.addEventListener("beforeunload",et),async()=>{await Z(),b.current&&b.current.disconnect()}),[]);let K=async()=>{if("text"===W&&ee(),"video"===W)try{A.current=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),A.current.getTracks().forEach(e=>e.stop()),ee()}catch(t){var e;null===(e=F.current)||void 0===e||e.set([{text:"Can't connect to your video device."},{text:"❌ ".concat(t)}])}},X=async()=>{z.current(null),k("assets/sounds/disconnect.mp3",.2),await ea(),y.autoRoll.video&&"video"==W||y.autoRoll.text&&"text"==W?(F.current.set([{text:"\uD83C\uDF29️ Auto-rolling..."}]),V.current([])):Q.current(!0),C.current&&await C.current.leave().receive("ok",e=>console.log("left room",e)),L.current&&clearTimeout(L.current),L.current=setTimeout(eo,0),er()},Z=async()=>{if(!j.current){if(j.current=!0,await ea(),z.current(null),y.autoRoll.video&&"video"===W||y.autoRoll.text&&"text"===W){var e;null===(e=F.current)||void 0===e||e.set([{text:"\uD83C\uDF29️ Auto-rolling..."}]),V.current([])}L.current&&clearTimeout(L.current),C.current&&(await C.current.leave().receive("ok",e=>console.log("left room",e)),await T.current.push("disconnect",{to:D.current.id,from:x,match_id:E.current}).receive("ok",()=>{console.log("$$$ push disconnect $$$",D.current.id)})),j.current=!1,er()}},ee=async()=>{var e,t;if(M.current)return;M.current=!0,clearTimeout(L.current),clearTimeout(I.current),window.spinLogo(Math.random()),F.current.set([{text:"⏳ Looking for someone you can chat with..."}]),$.interests=$.interests.map(e=>e.toLowerCase());let r={user:{...$,created_at:$.created_at.toString(),boost:null===(e=S())||void 0===e?void 0:e.token},config:{mode:W,settings:{interests:{wait:(null===(t=y.interests)||void 0===t?void 0:t.wait)||0}}},version:11};if("video"==W&&!p())throw"Video disconnected";T.current.push("start",r).receive("ok",e=>{console.log("$$$ start match $$$",e)}).receive("error",e=>{console.log("$$$ match error $$$",e),M.current=!1,"ratelimited"===e.code&&(O.current("start"),F.current.set([{text:"\uD83C\uDFC1 Press start to continue."}])),"captchafail"===e.code?O.current("captcha"):"outdated"===e.code&&F.current.set([{text:"Error connecting to match server."},{text:"❌ You're using an outdated version of Thundr, please refresh your browser and clear your cache to use the latest version of Thundr."}])})};if("video"===W){let e=i(D,x,A,q,H,T,J);h=e.createOffer,v=e.sendOffer,w=e.endVideo,p=e.isStreaming,_=e.reconnect,R=e.handleWebRTCMessage}let et=e=>{Z()},er=()=>{E.current=crypto.randomUUID()},en=()=>{T.current.off("matched"),T.current.on("matched",async e=>{console.log("$$$ matched! $$$",e),M.current=!1;let{room:t,match_id:r}=e;if(E.current=r,T.current.off("disconnect"),T.current.on("disconnect",e=>{console.log("$$$ user disconnected $$$",e),e.match_id==r&&(O.current("start"),X())}),"video"===W&&(T.current.off("webrtc_message"),T.current.on("webrtc_message",t=>{console.log("%%% webrtc message %%%",t),R(t,e.partner.id)})),D.current=e.partner,eu(t),"video"===W&&t.user.id!=x){let t=await h(e.partner.id);v(e.partner.id,t)}})},ec=()=>{T.current&&(T.current.off("disconnect"),T.current.off("matched"),T.current.leave());let e=new a.sk("wss://api.thundr.tv/socket");e.connect(),b.current=e,e.onError(e=>{"chatting"!==P.current&&O.current&&(O.current("error"),F.current&&F.current.set([{text:"❌ Error connecting to socket."}]))}),T.current=b.current.channel("match:".concat(x),{user:$}),T.current.join().receive("ok",async()=>{en()}).receive("error",e=>{"chatting"!==P.current&&F.current&&F.current.set([{text:"Error connecting to match."},{text:"❌ ".concat(e.reason)}])})},ea=async()=>{"video"==W&&(q.current(new MediaStream),await w())},eo=async()=>{"video"==W&&y.autoRoll.video&&await ee(),"text"==W&&y.autoRoll.text&&await ee()},es=()=>{y=r(),$=m()},ei=()=>{"chatting"!==P.current&&(k("assets/sounds/online.mp3",.2),O.current("chatting"))},eu=e=>{let{room_id:t}=e;ei(),es(),C.current=b.current.channel("room:".concat(t),{user:$}),C.current.join().receive("ok",async()=>{console.log("$$$ room join $$$",t),console.log("$$$ channel state $$$",C.current.state),ei()}).receive("error",e=>{console.log("error",e)}),C.current.off("message"),C.current.on("message",e=>{el({sender_id:e.sender_id,message:e.body})}),C.current.off("typing"),C.current.on("typing",e=>{e.sender_id!=x&&(e.typing?(k("assets/sounds/type.mp3",.03),z.current(!0)):z.current(!1))})},el=e=>{let{message:t,sender_id:r}=e;t.length<1||r===x||(k("assets/sounds/message.mp3",.2),V.current(e=>[...e,{text:t,sender_id:r}]))};return"video"===W?(0,n.jsxs)(c.xu,{display:"flex",flexDirection:"row",flex:"1",width:"100vw",bg:"black",children:[(0,n.jsx)(f.default,{setLocalStreamRef:H,setStreamRef:q,reconnect:_,partner:D,partnerVideoLoadingRef:J}),(0,n.jsx)(g.default,{user_id:x,channel:C,partner:D,disconnect:Z,messageInputRef:B,messagesBoxRef:N,setTypingRef:z,messagesRef:U,setMessagesRef:V,chatAlertsRef:F,disconnectedRef:G,setDisconnectedRef:Q,controlStateRef:O,currentControlStateRef:P,initialControlState:"waiting",findRoom:ee,setMode:Y,mode:W,matchChannel:T})]}):(0,n.jsx)(c.xu,{display:"flex",flexDirection:"row",flex:"1",width:"100vw",bg:"black",children:(0,n.jsx)(g.default,{user_id:x,channel:C,initialAlerts:[{text:"Connecting to server..."}],partner:D,disconnect:Z,messageInputRef:B,messagesBoxRef:N,setTypingRef:z,messagesRef:U,setMessagesRef:V,chatAlertsRef:F,disconnectedRef:G,setDisconnectedRef:Q,controlStateRef:O,currentControlStateRef:P,initialControlState:"waiting",findRoom:ee,setMode:Y,mode:W,matchChannel:T})})}}}]);